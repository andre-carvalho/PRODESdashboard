var utils={config:{},printWindow:null,statusPrint:false,setConfig:function(a){utils.config=a},onResize:function(a){clearTimeout(utils.config.resizeTimeout);utils.config.resizeTimeout=setTimeout(utils.rebuildAll,200)},updateDimensions:function(){var a={w:window.innerWidth,h:window.innerHeight};graph.setDimensions(a)},setDinamicTexts:function(){var a=graph.yearDimension.bottom(1),c=graph.yearDimension.top(1);var b=document.getElementById("year-range");b.innerText=a[0].year+" - "+c[0].year},totalRateCalculator:function(){var b=graph.ufRateGroup.top(Infinity);var a=0;b.forEach(function(c){a+=c.value});return a},rebuildAll:function(){utils.updateDimensions();graph.build()},addGenerationDate:function(){var d=document.getElementById("footer_page");var b=document.getElementById("footer_print");if(!d||!b){return}var c=((window.document.body.clientHeight>window.innerHeight)?(window.document.body.clientHeight):(window.innerHeight-20));b.style.width=window.innerWidth+"px";var a=new Date();var e="Gerado por INPE/OBT/DPI/TerraBrasilis em "+a.toLocaleString()+' sob licença <a target="blank_" href="https://creativecommons.org/licenses/by-sa/4.0/deed.pt_BR">CC BY-SA 4.0</a>';d.innerHTML=e;b.innerHTML=e}};var graph={barRateByYear:null,lineRateStatesByYear:null,pieTotalizedByState:null,ratesDataTable:null,relativeRatesDataTable:null,yearDimension:null,ufDimension:null,ufYearDimension:null,stateYearDimension:null,yearRateGroup:null,ufRateGroup:null,stateYearRateGroup:null,data:null,data_all:null,winWidth:window.innerWidth,winHeight:window.innerHeight,pallet:["#FF0000","#FF6A00","#FF8C00","#FFA500","#FFD700","#FFFF00","#DA70D6","#BA55D3","#7B68EE"],setDimensions:function(a){this.winWidth=a.w;this.winHeight=a.h},setChartReferencies:function(){this.barRateByYear=dc.barChart("#chart-by-year");this.lineRateStatesByYear=dc.seriesChart("#chart-by-year-state");this.pieTotalizedByState=dc.pieChart("#chart-by-state");this.ratesDataTable=dataTable("rates-data-table");this.relativeRatesDataTable=dataTable("relative-rates-data-table")},loadData:function(){d3.csv("data/prodes_rates_d.csv",graph.processData)},processData:function(b,d){if(b){throw b}var f=[],c=[];for(var a=0,g=d.length;a<g;++a){var e={uf:d[a].state,year:d[a].year,rate:+d[a].rate,ufYear:d[a].state+"/"+d[a].year};if(d[a].state=="AMZ"){c.push(e)}else{f.push(e)}}d=f;graph.data_all=c;graph.registerDataOnCrossfilter(d);graph.build()},registerDataOnCrossfilter:function(b){graph.data=b;var a=crossfilter(b);this.yearDimension=a.dimension(function(c){return c.year});this.ufDimension=a.dimension(function(c){return c.uf});this.ufYearDimension=a.dimension(function(c){return c.ufYear});this.stateYearDimension=a.dimension(function(c){return[c.uf,+c.year]});this.yearRateGroup=this.yearDimension.group().reduceSum(function(c){return +c.rate});this.ufRateGroup=this.ufDimension.group().reduceSum(function(c){return +c.rate});this.stateYearRateGroup=this.stateYearDimension.group().reduceSum(function(c){return +c.rate})},buildDataTable:function(){var a=[],d=[],c=[],b=[];graph.ufYearDimension.bottom(Infinity).forEach(function(e){if(!c[e.uf]){c[e.uf]=0;b.push(e.uf)}c[e.uf]+=e.rate;a.push({uf:e.uf,year:e.year,rate:localeBR.numberFormat(",1f")(e.rate),originalRate:e.rate});if(d.indexOf(e.year)<0){d.push(e.year)}});graph.data_all.forEach(function(e){if(d.indexOf(e.year)>=0){if(!c[e.uf]){c[e.uf]=0;b.push(e.uf)}c[e.uf]+=e.rate;a.push({uf:e.uf,year:e.year,rate:localeBR.numberFormat(",1f")(e.rate),originalRate:e.rate})}});graph.data2csv=jQuery.extend(true,[],a);graph.buildVariationRatesDataTable(a);b.forEach(function(e){a.push({uf:e,year:"Acumulado:",rate:localeBR.numberFormat(",1f")(c[e])})});graph.ratesDataTable.init(a);graph.ratesDataTable.redraw();utils.addGenerationDate()},buildVariationRatesDataTable:function(f){var a=[],b=f.length;for(var e=0;e<b;e++){if(f[e+1]&&f[e].uf==f[e+1].uf){var c=(f[e].originalRate>0)?(((100-(f[e+1].originalRate*100/f[e].originalRate))*(-1)).toFixed(0)+"%"):("");a.push({uf:f[e].uf,year:f[e].year+"-"+f[e+1].year,rate:c})}}graph.relativeRatesDataTable.init(a);graph.relativeRatesDataTable.redraw()},build:function(){var b=parseInt(this.winWidth-(this.winWidth*0.05)),d=parseInt(this.winHeight*0.3);this.setChartReferencies();utils.setDinamicTexts();var e=parseInt(b),a=parseInt((this.winHeight-d)*0.6);var c=graph.yearDimension.group().all();this.barRateByYear.height(a).width(parseInt((e/4)*3)).margins({top:0,right:10,bottom:45,left:45}).yAxisLabel("Desmatamento total anual (km²/ano)").xAxisLabel("Período de monitoramento da Amazônia Legal: "+c[0].key+" - "+c[c.length-1].key).dimension(this.yearDimension).group(this.yearRateGroup).title(function(f){return"Área: "+localeBR.numberFormat(",1f")(Math.abs(+(f.value.toFixed(1))))+" km²"}).label(function(g){var f=Math.abs((g.data.value/1000).toFixed(1));f=(f<1?localeBR.numberFormat(",1f")(parseInt(g.data.value)):localeBR.numberFormat(",1f")(f)+"k");return f}).elasticY(true).clipPadding(10).yAxisPadding("10%").x(d3.scale.ordinal()).xUnits(dc.units.ordinal).barPadding(0.3).outerPadding(0.1).renderHorizontalGridLines(true).ordinalColors(["gold"]);this.barRateByYear.on("renderlet.a",function(f){f.selectAll("g.x text").attr("transform","translate(-15,7) rotate(315)")});this.lineRateStatesByYear.width(e).height(a).margins({top:0,right:10,bottom:45,left:45}).chart(function(f){return dc.lineChart(f).interpolate("cardinal")}).x(d3.scale.ordinal()).xUnits(dc.units.ordinal).brushOn(false).yAxisLabel("Desmatamento por Estado (km²/ano)").xAxisLabel("Período de monitoramento da Amazônia Legal: "+c[0].key+" - "+c[c.length-1].key).renderHorizontalGridLines(true).renderVerticalGridLines(true).title(function(f){return"Estado: "+f.key[0]+"\nAno: "+f.key[1]+"\nÁrea: "+localeBR.numberFormat(",1f")(Math.abs(+(f.value.toFixed(2))))+" km²"}).elasticY(true).yAxisPadding("10%").dimension(this.stateYearDimension).group(this.stateYearRateGroup).mouseZoomable(false).seriesAccessor(function(f){return f.key[0]}).keyAccessor(function(f){return +f.key[1]}).valueAccessor(function(f){return +f.value}).ordinalColors(graph.pallet).seriesSort(function(g,f){var i=graph.ufRateGroup.top(Infinity);var h=[];i.forEach(function(j){h[j.key]=+j.value});return d3.descending(h[g],h[f])}).legend(dc.legend().x(e-graph.lineRateStatesByYear.margins().right-40).y(5).itemHeight(13).gap(7).horizontal(0).legendWidth(50).itemWidth(40));this.lineRateStatesByYear.on("renderlet.a",function(f){f.selectAll("g.x text").attr("transform","translate(-15,7) rotate(315)")});this.pieTotalizedByState.height(a).width(parseInt(e/4)).innerRadius(10).externalRadiusPadding(30).dimension(this.ufDimension).group(this.ufRateGroup).title(function(g){var f=utils.totalRateCalculator();f="Porcentagem: "+localeBR.numberFormat(",1f")((g.value*100/f).toFixed(1))+" %";f="Estado: "+g.key+"\n"+f+"\n";return f+"Área: "+localeBR.numberFormat(",1f")(Math.abs(+(g.value.toFixed(2))))+" km²"}).label(function(g){var f=utils.totalRateCalculator();return g.key+":"+localeBR.numberFormat(",1f")((g.value*100/f).toFixed(1))+" %"}).ordinalColors(graph.pallet).legend(dc.legend().x(1).y(5).itemHeight(13).gap(7).horizontal(0).legendWidth(50).itemWidth(40));this.pieTotalizedByState.on("postRedraw",this.buildDataTable);d3.select("#download").on("click",function(){var k=[],j=[],i=[];graph.data2csv.forEach(function(m){if(k.indexOf(m.uf)<0){k.push(m.uf);i[m.uf]=[]}if(j.indexOf(m.year)<0){j.push(m.year)}i[m.uf][m.year]=m.originalRate});var g=[],f={};k.forEach(function(m){j.forEach(function(o){if(f[o]){n=f[o]}else{var n={};n.year=o;f[o]=n}n[m]=i[m][o]})});for(var l in f){if(f.hasOwnProperty(l)){g.push(f[l])}}var h=new Blob([d3.csv.format(g)],{type:"text/csv;charset=utf-8"});saveAs(h,"taxas_anuais_prodes.csv")});dc.renderAll();this.buildDataTable()},init:function(){window.onresize=utils.onResize;this.loadData()},resetFilter:function(a){if(a=="year"){graph.barRateByYear.filterAll()}else{if(a=="state"){graph.pieTotalizedByState.filterAll()}}dc.redrawAll()}};graph.init();